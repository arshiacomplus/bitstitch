name: BitStitch Multi-Platform Release

on:
  push:
    tags:
      - 'v*'

jobs:
  android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with: { java-version: '17', distribution: 'temurin' }
      - uses: subosito/flutter-action@v2
        with: { channel: 'stable' }

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks

      - name: Build APKs (Universal & Splits)
        env:
          KEYSTORE_PATH: "upload-keystore.jks"
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
        run: |
          flutter build apk --release --split-per-abi
          flutter build apk --release

      - name: Upload Android Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: build/app/outputs/flutter-apk/*.apk

  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with: { channel: 'stable' }
      - name: Build Windows
        run: flutter build windows --release
      - name: Upload Windows
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: build/windows/x64/runner/Release/*

  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with: { channel: 'stable' }
      - name: Install Dependencies
        run: |
git tag v1.0.0
git push origin v1.0.0          sudo apt-get update
          sudo apt-get install -y --fix-missing clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev
      - name: Build Linux
        run: flutter build linux --release
      - name: Create DEB Package
        run: |
          mkdir -p debian/usr/bin
          cp build/linux/x64/release/bundle/bitstitch debian/usr/bin/
          zip -r bitstitch-linux.zip build/linux/x64/release/bundle/*

      - name: Upload Linux
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: bitstitch-linux.zip

  release:
    needs: [android, windows, linux]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            android-builds/*.apk
            windows-build/*
            linux-build/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}